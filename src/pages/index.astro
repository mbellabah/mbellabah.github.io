---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('posts', ({ data }) => {
  return data.draft !== true;
});

// Sort posts by date (newest first)
const sortedPosts = posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Function to extract plain text and create excerpt
function createExcerpt(content: string, maxLength: number = 200): string {
  // Remove markdown syntax and HTML tags
  const plainText = content
    .replace(/^---[\s\S]*?---/gm, '') // Remove frontmatter
    .replace(/^import\s+.*$/gm, '') // Remove import statements
    .replace(/\$\$[\s\S]*?\$\$/g, '') // Remove LaTeX display math blocks
    .replace(/\$[^$]*\$/g, '') // Remove LaTeX inline math
    .replace(/<[^>]+>/g, '') // Remove HTML tags
    .replace(/```[\s\S]*?```/g, '') // Remove code blocks
    .replace(/`[^`]+`/g, '') // Remove inline code
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Remove markdown links
    .replace(/\[\^[^\]]+\]/g, '') // Remove footnote references
    .replace(/!\[([^\]]*)\]\([^)]+\)/g, '') // Remove images
    .replace(/\*\*([^*]+)\*\*/g, '$1') // Remove bold
    .replace(/\*([^*]+)\*/g, '$1') // Remove italic
    .replace(/_{1,2}([^_]+)_{1,2}/g, '$1') // Remove underline emphasis
    .replace(/~~([^~]+)~~/g, '$1') // Remove strikethrough
    .replace(/^#{1,6}\s+/gm, '') // Remove headers
    .replace(/^[-*_]{3,}$/gm, '') // Remove horizontal rules
    .replace(/^>\s+/gm, '') // Remove blockquotes
    .replace(/^\s*[-*+]\s+/gm, '') // Remove unordered list markers
    .replace(/^\s*\d+\.\s+/gm, '') // Remove ordered list markers
    .replace(/\\\\/g, '') // Remove escaped backslashes
    .replace(/\\(.)/g, '$1') // Remove other escape characters
    .replace(/\n+/g, ' ') // Replace newlines with spaces
    .replace(/\s+/g, ' ') // Normalize whitespace
    .trim();
  
  if (plainText.length <= maxLength) return plainText;
  
  // Find the last complete word within the limit
  const truncated = plainText.substring(0, maxLength);
  const lastSpace = truncated.lastIndexOf(' ');
  return truncated.substring(0, lastSpace) + '...';
}
---

<BaseLayout title="Mohamadou Bella Bah">
  <div class="py-12">
    <!-- Hero Section -->
    <section class="mb-16 pt-4">
      <p class="font-serif text-lg text-gray-600 leading-relaxed max-w-2xl">
        Founder of <a href="https://www.auxmachines.com" class="font-medium text-gray-900 hover:text-indigo-700 transition-colors">Auxiliary Machines</a>. Building <a href="https://www.runlattice.com" class="font-medium text-gray-900 hover:text-indigo-700 transition-colors">Lattice</a>, an investigation platform for complex defects.
      </p>
    </section>

    <!-- Section Header -->
    <div class="flex items-center justify-between mb-8 border-b border-gray-200 pb-4">
      <h3 class="text-xs font-bold tracking-widest text-gray-400 uppercase">Featured</h3>
    </div>

    <!-- Featured Articles -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-10 mb-20">
      {sortedPosts.filter(post => ['gedanken-spheres', 'factories-without-pause'].includes(post.slug)).map(post => {
        const excerpt = createExcerpt(post.body);
        return (
          <article class="group relative flex flex-col h-full">
            <header>
              <h2 class="text-2xl font-serif font-medium mb-3 text-gray-900 group-hover:text-indigo-700 transition-colors leading-tight">
                <a href={`/posts/${post.slug}`}>
                  <span class="absolute inset-0"></span>
                  {post.data.title}
                </a>
              </h2>
            </header>
            
            <div class="mb-4 flex-grow">
              <p class="text-gray-500 text-[1.05rem] leading-relaxed font-serif antialiased line-clamp-3">
                {excerpt}
              </p>
            </div>
            
            <footer class="flex items-center text-xs text-gray-400 font-medium font-sans mt-auto pt-2">
              <span>{Math.ceil(post.body.split(/\s+/).length / 200)} min read</span>
              
              {post.data.tags && post.data.tags.length > 0 && (
                <>
                  <span class="mx-2">·</span>
                  <div class="flex gap-2 relative z-10">
                    {post.data.tags.slice(0, 1).map(tag => (
                      <span class="uppercase tracking-wider hover:text-indigo-600 transition-colors cursor-pointer">
                        {tag}
                      </span>
                    ))}
                  </div>
                </>
              )}
            </footer>
          </article>
        );
      })}
    </div>

    <!-- Section Header -->
    <div class="flex items-center justify-between mb-12 border-b border-gray-200 pb-4">
      <h3 class="text-xs font-bold tracking-widest text-gray-400 uppercase">Latest</h3>
    </div>

    <!-- Articles List -->
    <div class="space-y-16">
      {sortedPosts.map(async (post) => {
        const { remarkPluginFrontmatter } = await post.render();
        const rawContent = post.body;
        const excerpt = createExcerpt(rawContent);
        
        return (
          <article class="group relative">
            <header class="mb-3">
              <h2 class="text-2xl font-serif font-medium mb-3 text-gray-900 group-hover:text-gray-600 transition-colors">
                <a href={`/posts/${post.slug}`}>
                  <span class="absolute inset-0"></span>
                  {post.data.title}
                </a>
              </h2>
            </header>
            
            <div class="mb-4">
              <p class="text-gray-500 text-[1.05rem] leading-relaxed font-serif antialiased">{excerpt}</p>
            </div>
            
            <footer class="flex items-center text-xs text-gray-400 font-medium font-sans mt-auto">
              <time datetime={post.data.date.toString()}>
                {post.data.date.toLocaleDateString('en-US', { 
                  year: 'numeric', 
                  month: 'short', 
                  day: 'numeric' 
                })}
              </time>
              
              <span class="mx-2">·</span>
              <span>{Math.ceil(post.body.split(/\s+/).length / 200)} min read</span>
              
              {post.data.tags && post.data.tags.length > 0 && (
                <>
                  <span class="mx-2">·</span>
                  <div class="flex gap-2 relative z-10">
                    {post.data.tags.slice(0, 1).map(tag => (
                      <span class="uppercase tracking-wider hover:text-indigo-600 transition-colors cursor-pointer">
                        {tag}
                      </span>
                    ))}
                  </div>
                </>
              )}
            </footer>
          </article>
        );
      })}
    </div>
  </div>
</BaseLayout>
