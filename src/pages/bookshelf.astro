---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const books = await getCollection('books');

// Helper function to get date for sorting and statistics
function getBookDate(book: any): Date | null {
  const dateCompleted = book.data.dateCompleted;
  if (dateCompleted instanceof Date) {
    return dateCompleted;
  }
  if (typeof dateCompleted === 'string' && dateCompleted !== 'Unknown') {
    return new Date(dateCompleted);
  }
  return null;
}

// Helper function to format date for display
function formatBookDate(book: any): string {
  const dateCompleted = book.data.dateCompleted;
  if (dateCompleted === 'Unknown') {
    return 'Unknown';
  }
  
  const date = getBookDate(book);
  if (date) {
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short' 
    });
  }
  return 'Unknown';
}

// Sort books by completion date (most recent first), with unknown dates at the end
const sortedBooks = books.sort((a, b) => {
  const dateA = getBookDate(a);
  const dateB = getBookDate(b);
  
  if (!dateA && !dateB) return 0;
  if (!dateA) return 1;  // Unknown dates go to end
  if (!dateB) return -1; // Unknown dates go to end
  
  return dateB.getTime() - dateA.getTime();
});

// Helper function to split genres
function splitGenres(genreString: string): string[] {
  return genreString.split(',').map(genre => genre.trim()).filter(genre => genre.length > 0);
}

// Get unique genres for filtering
const allGenres = books.flatMap(book => splitGenres(book.data.genre || ''));
const genres = [...new Set(allGenres)].sort();

// Get reading statistics
const currentYear = new Date().getFullYear();
const booksWithDates = books.filter(book => getBookDate(book) !== null);
const booksThisYear = booksWithDates.filter(book => {
  const date = getBookDate(book);
  return date && date.getFullYear() === currentYear;
}).length;
const totalYears = new Set(booksWithDates.map(book => {
  const date = getBookDate(book);
  return date ? date.getFullYear() : null;
}).filter(year => year !== null)).size;
const averagePerYear = totalYears > 0 ? Math.round(booksWithDates.length / totalYears) : 0;

function createExcerpt(content: string | undefined, maxLength: number = 120): string {
  if (!content || content.length <= maxLength) return content || '';
  const truncated = content.substring(0, maxLength);
  const lastSpace = truncated.lastIndexOf(' ');
  return truncated.substring(0, lastSpace) + '...';
}
---

<BaseLayout title="Bookshelf - Mohamadou Bella Bah">
  <div>
    <header class="mb-12 pt-8">
      <h1 class="text-4xl md:text-5xl font-serif font-medium mb-6 text-gray-900 tracking-tight">Bookshelf</h1>
      <div class="flex flex-wrap gap-x-8 gap-y-2 text-sm font-sans text-gray-500 border-l-2 border-gray-200 pl-4">
        <span class="flex items-center gap-2">
          <strong class="text-gray-900 font-medium">{books.length}</strong> books total
        </span>
        <span class="flex items-center gap-2">
          <strong class="text-gray-900 font-medium">{booksThisYear}</strong> read in {currentYear}
        </span>
        {averagePerYear > 0 && (
          <span class="flex items-center gap-2">
            <strong class="text-gray-900 font-medium">~{averagePerYear}</strong> per year
          </span>
        )}
      </div>
    </header>

    {/* Filter buttons */}
    <div class="mb-12 flex flex-wrap gap-2">
      <button class="filter-btn active" data-filter="all">
        All
      </button>
      {genres.map(genre => (
        <button class="filter-btn" data-filter={genre}>
          {genre}
        </button>
      ))}
    </div>

    {/* Books list */}
    <div class="space-y-12">
      {sortedBooks.map((book) => {
        const rawContent = book.body;
        const excerpt = createExcerpt(rawContent);
        
        return (
          <article class="book-item group" data-genres={splitGenres(book.data.genre || '').join(',')}>
            <div class="flex flex-col sm:flex-row sm:items-baseline justify-between mb-3 gap-2">
              <div class="flex-1">
                <h2 class="text-2xl font-serif font-medium text-gray-900 leading-tight">
                  {book.data.title}
                </h2>
                <div class="text-gray-500 font-serif italic mt-1 text-[1.05rem]">
                  {book.data.author}
                </div>
              </div>
              
              <div class="flex items-center gap-4 text-sm font-sans shrink-0">
                {book.data.rating && (
                  <div class="flex text-indigo-700 opacity-80" aria-label={`Rating: ${book.data.rating} out of 5`}>
                    {Array.from({ length: 5 }, (_, i) => (
                      <span class={i < (book.data.rating || 0) ? 'text-indigo-600' : 'text-gray-200'}>
                        ★
                      </span>
                    ))}
                  </div>
                )}
                <div class="text-gray-400 tabular-nums">
                  {formatBookDate(book)}
                </div>
              </div>
            </div>
            
            {/* Tags/Genres row */}
            <div class="flex flex-wrap gap-2 mb-4">
              {splitGenres(book.data.genre || '').map(genre => (
                <span class="text-[0.7rem] uppercase tracking-wider font-medium text-gray-400 border border-gray-100 px-2 py-0.5 rounded-full">
                  {genre}
                </span>
              ))}
            </div>
            
            {rawContent && (
              <div class="review-content relative pl-4 border-l-2 border-gray-100 hover:border-indigo-100 transition-colors">
                <div class="text-gray-600 leading-relaxed font-serif text-[1.05rem] excerpt">
                  {excerpt}
                </div>
                {rawContent.length > 120 && (
                  <>
                    <div class="text-gray-600 leading-relaxed font-serif text-[1.05rem] full-review space-y-4" style="display: none;">
                      {rawContent}
                    </div>
                    <button class="expand-btn text-xs font-sans font-medium text-gray-400 hover:text-indigo-600 transition-colors mt-3 flex items-center gap-1">
                      Read review <span class="text-[10px]">↓</span>
                    </button>
                  </>
                )}
              </div>
            )}
          </article>
        );
      })}
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const filterButtons = document.querySelectorAll('.filter-btn');
      const bookItems = document.querySelectorAll('.book-item');
      const expandButtons = document.querySelectorAll('.expand-btn');
      
      // Filter functionality
      filterButtons.forEach(button => {
        button.addEventListener('click', function(event) {
          const target = event.target as HTMLElement;
          const filter = target.getAttribute('data-filter');
          
          // Update active button
          filterButtons.forEach(btn => btn.classList.remove('active'));
          target.classList.add('active');
          
          // Filter books
          bookItems.forEach(item => {
            const htmlItem = item as HTMLElement;
            const genres = htmlItem.getAttribute('data-genres')?.split(',') || [];
            if (filter === 'all' || genres.includes(filter)) {
              htmlItem.style.display = 'block';
            } else {
              htmlItem.style.display = 'none';
            }
          });
        });
      });
      
      // Expand/collapse review functionality
      expandButtons.forEach(button => {
        button.addEventListener('click', function(event) {
          const target = event.target as HTMLElement;
          const reviewContent = target.closest('.review-content') as HTMLElement;
          const excerpt = reviewContent.querySelector('.excerpt') as HTMLElement;
          const fullReview = reviewContent.querySelector('.full-review') as HTMLElement;
          
          if (fullReview.style.display === 'none') {
            // Expand
            excerpt.style.display = 'none';
            fullReview.style.display = 'block';
            target.innerHTML = 'Collapse review <span class="text-[10px]">↑</span>';
          } else {
            // Collapse
            excerpt.style.display = 'block';
            fullReview.style.display = 'none';
            target.innerHTML = 'Read review <span class="text-[10px]">↓</span>';
          }
        });
      });
    });
  </script>

  <style>
    .filter-btn {
      padding: 0.35rem 1rem;
      font-size: 0.8rem;
      font-family: var(--font-sans);
      border: 1px solid transparent;
      border-radius: 9999px; /* Pill shape */
      background-color: #f3f4f6;
      color: #4b5563;
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
      cursor: pointer;
      font-weight: 500;
    }
    
    .filter-btn:hover {
      background-color: #e5e7eb;
      transform: translateY(-1px);
    }
    
    .filter-btn.active {
      background-color: #4338ca; /* Indigo 700 */
      color: white;
      box-shadow: 0 4px 6px -1px rgba(67, 56, 202, 0.2);
    }
    
    .filter-btn.active:hover {
      background-color: #3730a3; /* Indigo 800 */
    }
  </style>
</BaseLayout>